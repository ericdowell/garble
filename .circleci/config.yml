version: 2
jobs:
  build:
    docker:
      - image: ericdowell/laravel-circleci:latest
      - image: redis:latest
      - image: mysql:5.7
        environment:
          - MYSQL_DATABASE=forge
          - MYSQL_USER=forge
          - MYSQL_PASSWORD=''
          - MYSQL_ALLOW_EMPTY_PASSWORD=true
          - MYSQL_ROOT_HOST=%
    environment:
      TZ: "/usr/share/zoneinfo/America/Chicago"
    steps:
      - checkout
      - run:
          name: Copy circle env file
          command: cp .env.circle .env
      - restore_cache:
          keys:
            - npm-install-build-{{ checksum "package-lock.json" }}
      - run:
          name: Install NPM Dependencies
          command: npm install
      - save_cache:
          key: npm-install-build-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
      - run:
          name: Compile assets
          command: npm run prod
      - restore_cache:
          keys:
            - composer-install-build-{{ checksum "composer.lock" }}
      - run:
          name: Install PHP Dependencies
          command: composer install --no-interaction --optimize-autoloader --prefer-dist
      - save_cache:
          key: composer-install-build-{{ checksum "composer.lock" }}
          paths:
            - vendor
      - run:
          name: Generate App Key
          command: php artisan key:generate
      - run:
          name: Remove node_modules folder since it is no longer needed.
          command: rm -rf node_modules
      - run:
          name: Wait for MySQL
          command: dockerize -wait tcp://localhost:3306 -timeout 1m
      - run:
          name: Run Database Migration
          command: php artisan migrate
      - run:
          name: Fix app folder permissions
          command: sudo chmod -R 0777 storage/ && sudo chmod -R 0775 bootstrap/cache/ && sudo chmod 0775 public/robots.txt
      - run:
          name: Run Unit Tests and Generate Code Coverage XML File
          command: php vendor/bin/phpunit
      - store_test_results:
          path: build/junit
      - store_artifacts:
          path: build/junit
      - run:
          name: Attempt to Send Code Coverage XML File
          command: |
            if [ -z ${CODECLIMATE_REPO_TOKEN+x} ]; then echo "CODECLIMATE_REPO_TOKEN not set"; else ./vendor/bin/test-reporter || echo 'Nothing sent, failed'; fi
      - run:
          name: Disable xdebug extension
          command: sudo rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
      - run:
          name: Start xvfb
          command: /usr/bin/Xvfb :0 -screen 0 2920x2580x24
          background: true
      - run:
          name: Open Browsers
          command: DISPLAY=:0 ./vendor/laravel/dusk/bin/chromedriver-linux
          background: true
      - run:
          name: Run Laravel Dusk Tests
          command: php artisan dusk
